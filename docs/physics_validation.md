# 物理的妥当性の検証

## 概要

本文書は、Neural Wave Simulator の各モデルにおけるエネルギー保存則の検証結果をまとめたものです。

---

## 1. エネルギー保存則の理論

### 1次元波動方程式

$$
\frac{\partial^2 u}{\partial t^2} = c^2 \frac{\partial^2 u}{\partial x^2}
$$

### 全エネルギー（連続系）

$$
E(t) = \frac{1}{2} \int_0^L \left[ \left(\frac{\partial u}{\partial t}\right)^2 + c^2 \left(\frac{\partial u}{\partial x}\right)^2 \right] dx
$$

- **第1項**: 運動エネルギー (K)
- **第2項**: ポテンシャルエネルギー (P)

### 保存則

理想的には $\frac{dE}{dt} = 0$ （エネルギー保存）

---

## 2. 検証結果

### 2.1 物理ベースモデル（差分法）

**実装:** 中心差分法による陽的スキーム

**検証結果:**
- 総エネルギー変動: **4.28%**
- CFL数: 0.50
- 評価: ✅ **許容範囲内**

**詳細:**
```
平均総エネルギー: 0.450432
標準偏差: 0.006229 (1.383%)
変動範囲: 4.275%

運動エネルギー (K):
  平均値: 0.222295
  最大値: 0.446578
  最小値: 0.000059

ポテンシャルエネルギー (P):
  平均値: 0.228138
  最大値: 0.445255
  最小値: 0.000016
```

**周波数解析:**
- 支配的な周波数: 0.1074 Hz → **第2モード** (理論値 0.1000 Hz)
- 対応する周期: 9.309 秒

**物理的解釈:**
- K と P が周期的に交換（定在波の正常な特性）
- 初期条件（ガウスパルス、中心 x=5.0）の対称性により **偶数モード** が優勢
- 第2モードが支配的な理由: ガウスの特性波数と第2モードの波数が近い

**数値誤差の原因:**
1. 境界条件の離散化誤差
2. Courant数 C=0.5 による数値分散
3. 長時間積分での誤差蓄積

**改善案:**
- CFL数を 1.0 に近づける → 変動率 < 1% 達成可能

---

### 2.2 PINNs モデル

**実装:** Physics-Informed Neural Networks

**検証結果:**
- エネルギー挙動: **減衰傾向** ⚠️
- K と P の周期的交換: 観測される
- 評価: **学習改善が必要**

**問題点:**
- 総エネルギーが時間とともに減少
- エネルギー保存則を損失関数に組み込んでいない

**改善案:**
1. エネルギー保存則を損失関数に追加
2. PDE 残差の重みを調整
3. 学習データの多様化

---

### 2.3 データ駆動型モデル

**実装:** 純粋なニューラルネットワーク（逐次予測）

**検証結果:**
- エネルギー挙動: **加速度的に増加** ❌
- ポテンシャルエネルギーが特に増大
- 評価: **物理制約の追加が必須**

**問題点:**
1. 逐次予測による誤差の蓄積
2. 物理法則（エネルギー保存）を学習していない
3. 学習データのバリエーション不足

**改善案:**
1. エネルギー保存則を損失関数に追加
2. Teacher Forcing の導入
3. 長期予測の学習データ生成
4. 正則化の強化

---

## 3. 初期条件による数値安定性

### 3.1 問題の発見

差分法シミュレーターにおいて、特定の初期条件下で数値発散が発生:

| 初期条件 | 変動率（修正前） | 状態 |
|---------|----------------|------|
| center=1.0 | 120.25% | ❌ 発散 |
| center=9.0 | 120.25% | ❌ 発散 |
| width=0.3 | 16.22% | ⚠️ 不安定 |
| width=0.5 | 8.79% | ⚠️ 不安定 |
| width=3.0 | 122.56% | ❌ 発散 |

### 3.2 原因分析

#### (1) 境界条件との不整合

**問題:**

固定端境界条件 $u(0, t) = u(L, t) = 0$ に対し、初期条件がこの条件を満たさない場合:

$$
u(0, 0) = h \exp\left(-\frac{x_0^2}{2\sigma^2}\right) \neq 0 \quad \text{when } x_0 \approx 0
$$

**結果:** 数値的に高周波モードが励起され、CFL条件ギリギリで増幅

#### (2) 空間解像度不足

**ガウスパルスの特性波長:**

$$
\lambda_c = 2\pi\sigma
$$

**必要な解像度（Nyquist-Shannon定理）:**

$$
\Delta x \le \frac{\lambda_c}{10} = \frac{2\pi\sigma}{10}
$$

**width=0.3 の場合:**

$$
\lambda_c = 2\pi \times 0.3 = 1.88 \, \text{m}
$$

必要: $\Delta x \le 0.188$ だが、実際は $\Delta x = 0.1$

一見十分だが、**高周波成分（$k \sim 3/\sigma$）まで考慮すると不足**

#### (3) 境界との干渉

パルス幅が大きい（$\sigma > L/4$）場合、境界反射波との重ね合わせで予期しない共鳴が発生。

---

### 3.3 修正手法

#### A. 境界減衰処理（Window Function）

初期条件に境界減衰を適用:

$$
\tilde{u}(x, 0) = w(x) \cdot u(x, 0)
$$

$$
w(x) = \begin{cases}
\displaystyle \frac{x}{3\Delta x} & 0 \le x < 3\Delta x \\[8pt]
1 & 3\Delta x \le x \le L - 3\Delta x \\[8pt]
\displaystyle \frac{L - x}{3\Delta x} & L - 3\Delta x < x \le L
\end{cases}
$$

**効果:**

1. **境界で厳密にゼロ:** $\tilde{u}(0, 0) = w(0) \cdot u(0, 0) = 0$
2. **滑らかな遷移:** $dw/dx = 1/(3\Delta x)$ は有限
3. **内部で元の初期条件を保持:** $w(x) = 1$ for $x \in [0.3, 9.7]$（85%の領域）

**エネルギー減少の評価:**

$$
\frac{\Delta E}{E_0} = \frac{\int_0^{3\Delta x} u^2 dx}{\int_0^L u^2 dx} < 5\%
$$

#### B. 初期条件の検証

```python
# 境界からの安全距離
margin = max(3 * width, 5 * dx)

# 幅の範囲制限
min_width = 10 * dx / (2 * π)  # 特性波長を10点で解像
max_width = L / 4              # 領域の1/4以下

# 検証
if center < margin or center > L - margin:
    raise ValueError("境界に近すぎる")
if width < min_width or width > max_width:
    raise ValueError("幅が不適切")
```

**計算例（dx=0.1, L=10.0）:**

$$
\text{min\_width} = \frac{10 \times 0.1}{2\pi} \approx 0.159
$$

$$
\text{max\_width} = \frac{10.0}{4} = 2.5
$$

$$
\text{margin} = \max(3 \times 1.0, 5 \times 0.1) = 3.0
$$

→ 推奨範囲: $3.0 \le \text{center} \le 7.0$

---

### 3.4 修正結果

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| **発散ケース** | 3/15 (20%) | 0/15 (0%) ✅ |
| **不安定ケース** | 3/15 (20%) | 2/15 (13%) ⚠️ |
| **検証拒否** | 0/15 (0%) | 6/15 (40%) 🛡️ |
| **安定ケース** | 9/15 (60%) | 7/15 (47%) |
| **最大変動率** | 122.56% | 16.22% |

**詳細:**

```
修正後の実行結果:

center=1.0: ⛔ 検証拒否（境界に近い）
center=2.5: ⛔ 検証拒否（境界に近い）
center=5.0: ✅ 安定（変動率 4.22%）
center=7.5: ⛔ 検証拒否（境界に近い）
center=9.0: ⛔ 検証拒否（境界に近い）

width=0.3: ⚠️ 不安定（変動率 16.22%、解像度警告）
width=0.5: ⚠️ 不安定（変動率 8.79%、解像度警告）
width=1.0: ✅ 安定（変動率 4.22%）
width=2.0: ⛔ 検証拒否（中心が境界に近くなる）
width=3.0: ⛔ 検証拒否（広すぎる）

height=0.5~10.0: すべて ✅ 安定（変動率 4.22%）
```

---

### 3.5 理論的裏付け

#### Von Neumann 安定性解析

離散化された波動方程式の増幅因子:

$$
G = 1 - 4C^2 \sin^2\left(\frac{k\Delta x}{2}\right)
$$

CFL数 $C = 0.5$ の場合:

$$
|G| = \sqrt{1 - \sin^2(k\Delta x / 2)} \le 1 \quad \forall k
$$

**境界減衰の効果:**

高波数成分（$k \gtrsim \pi/\Delta x$）を初期時刻で抑制 → 増幅の芽を摘む

#### 数値分散の抑制

差分法の分散関係:

$$
\omega_d^2 = \frac{4c^2}{\Delta x^2} \sin^2\left(\frac{k\Delta x}{2}\right)
$$

真の分散関係 $\omega^2 = c^2 k^2$ との誤差:

$$
\frac{\omega_d}{\omega} = \frac{2}{k\Delta x} \sin\left(\frac{k\Delta x}{2}\right)
$$

**width=1.0 の場合:**

特性波数 $k_c = 1/\sigma = 1.0$ rad/m

$$
k_c \Delta x = 1.0 \times 0.1 = 0.1 \ll \pi
$$

$$
\frac{\omega_d}{\omega} \approx 1 - \frac{(k\Delta x)^2}{24} \approx 0.9996
$$

→ **誤差 0.04%（非常に小さい）**

**width=0.3 の場合:**

$$
k_c = 1/0.3 \approx 3.33 \text{ rad/m}
$$

$$
k_c \Delta x = 3.33 \times 0.1 = 0.333
$$

$$
\frac{\omega_d}{\omega} \approx 0.982
$$

→ **誤差 1.8%（無視できない）**

これが蓄積して 200 ステップ後に **16%の変動率** につながる。

---

### 3.6 結論

✅ **境界減衰処理と初期条件検証により、すべての発散ケースを解消**

✅ **エネルギー保存則を維持（変動率 < 5% または事前検証で拒否）**

✅ **物理的に不適切な初期条件を実行前に検出**

⚠️ **狭いパルス（width < 0.5）は解像度不足の警告付きで実行可能**
   → ユーザーの判断に委ねる（教育・デモ用途なら許容）

---

**参考文献:**

- LeVeque, R. J. (2007). *Finite Difference Methods for Ordinary and Partial Differential Equations*
- Courant, R., Friedrichs, K., & Lewy, H. (1928). "Über die partiellen Differenzengleichungen der mathematischen Physik"
- Trefethen, L. N. (1996). "Finite Difference and Spectral Methods for Ordinary and Partial Differential Equations"

---

*最終更新: 2025年12月11日*
