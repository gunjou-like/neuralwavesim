# 物理的妥当性の検証

## 概要

本文書は、Neural Wave Simulator の各モデルにおけるエネルギー保存則の検証結果をまとめたものです。

---

## 1. エネルギー保存則の理論

### 1次元波動方程式

$$
\frac{\partial^2 u}{\partial t^2} = c^2 \frac{\partial^2 u}{\partial x^2}
$$

### 全エネルギー（連続系）

$$
E(t) = \frac{1}{2} \int_0^L \left[ \left(\frac{\partial u}{\partial t}\right)^2 + c^2 \left(\frac{\partial u}{\partial x}\right)^2 \right] dx
$$

- **第1項**: 運動エネルギー (K)
- **第2項**: ポテンシャルエネルギー (P)

### 保存則

理想的には $\frac{dE}{dt} = 0$ （エネルギー保存）

---

## 2. 検証結果

### 2.1 物理ベースモデル（差分法）

**実装:** 中心差分法による陽的スキーム

**検証結果:**
- 総エネルギー変動: **4.28%**
- CFL数: 0.50
- 評価: ✅ **許容範囲内**

**詳細:**
```
平均総エネルギー: 0.450432
標準偏差: 0.006229 (1.383%)
変動範囲: 4.275%

運動エネルギー (K):
  平均値: 0.222295
  最大値: 0.446578
  最小値: 0.000059

ポテンシャルエネルギー (P):
  平均値: 0.228138
  最大値: 0.445255
  最小値: 0.000016
```

**周波数解析:**
- 支配的な周波数: 0.1074 Hz → **第2モード** (理論値 0.1000 Hz)
- 対応する周期: 9.309 秒

**物理的解釈:**
- K と P が周期的に交換（定在波の正常な特性）
- 初期条件（ガウスパルス、中心 x=5.0）の対称性により **偶数モード** が優勢
- 第2モードが支配的な理由: ガウスの特性波数と第2モードの波数が近い

**数値誤差の原因:**
1. 境界条件の離散化誤差
2. Courant数 C=0.5 による数値分散
3. 長時間積分での誤差蓄積

**改善案:**
- CFL数を 1.0 に近づける → 変動率 < 1% 達成可能

---

### 2.2 PINNs モデル

**実装:** Physics-Informed Neural Networks

**検証結果:**
- エネルギー挙動: **減衰傾向** ⚠️
- K と P の周期的交換: 観測される
- 評価: **学習改善が必要**

**問題点:**
- 総エネルギーが時間とともに減少
- エネルギー保存則を損失関数に組み込んでいない

**改善案:**
1. エネルギー保存則を損失関数に追加
2. PDE 残差の重みを調整
3. 学習データの多様化

---

### 2.3 データ駆動型モデル

**実装:** 純粋なニューラルネットワーク（逐次予測）

**検証結果:**
- エネルギー挙動: **加速度的に増加** ❌
- ポテンシャルエネルギーが特に増大
- 評価: **物理制約の追加が必須**

**問題点:**
1. 逐次予測による誤差の蓄積
2. 物理法則（エネルギー保存）を学習していない
3. 学習データのバリエーション不足

**改善案:**
1. エネルギー保存則を損失関数に追加
2. Teacher Forcing の導入
3. 長期予測の学習データ生成
4. 正則化の強化

---

### 2.4 Data-Driven v2（改善試行）⚠️

#### 改善試行内容

**目的**: エネルギー保存の改善

**改善策**:
1. エネルギー正則化項の追加
2. 滑らかさ制約
3. 振幅制約
4. データ拡張（ノイズ、スケーリング）

**実装**:
```python
loss = (loss_mse + 
       λ_energy * loss_energy + 
       λ_smooth * loss_smooth + 
       λ_amp * loss_amp)
```

**重み設定**:
- λ_mse = 1.0
- λ_energy = 0.5
- λ_smooth = 0.1
- λ_amp = 0.3

---

#### 検証結果（失敗）

**テスト条件**:
- Grid: 100 x 100
- Time: 5.0 s（訓練データと同じ）
- Initial: Gaussian pulse

**エネルギー変動率**:
- Physics-based: 4.17% ✅
- **Data-Driven v2: 129.34%** ❌

**評価**: 失敗

---

#### 失敗の原因分析

**1. 累積誤差の問題**

LSTMによる逐次予測では誤差が累積：
```
Error(t) = ε₁ + ε₂ + ... + εₜ
```

波動方程式のようなエネルギー保存系では、この累積誤差が発散を招く。

**2. モデルアーキテクチャの限界**

- LSTM: 時系列の短期依存性を捉える
- 波動方程式: 長距離の空間的相互作用が重要

→ **根本的にミスマッチ**

**3. 正則化の限界**

エネルギー保存を損失関数に追加しても：
- 1ステップ予測では効果的
- 多ステップ累積では無力

---

#### 教訓

**データ駆動型モデルが不向きな問題**:
1. ✅ 短期予測（1-2ステップ）
2. ❌ 長期予測（100ステップ以上）
3. ❌ エネルギー保存則が重要な系
4. ❌ 物理法則の厳密な再現

**適切なアプローチ**:
- 物理法則が既知 → **PINNs** ⭐
- 物理法則が不明 → データ駆動型
- 高速計算が必要 → 物理ベース（有限差分法）

---

#### 今後の方針

データ駆動型モデルのさらなる改善は**費用対効果が低い**と判断。

代わりに：
1. **PINNs v2 を主力モデルとして推進** ⭐
2. 物理ベースモデルの高速化
3. ハイブリッドアプローチの検討

---

## 3. 総合評価

### 3.1 モデル比較サマリー（更新版）

| モデル | エネルギー変動 | 計算速度 | 精度 | 総合評価 |
|--------|---------------|---------|------|----------|
| Physics-based | 4.17% | ⚡⚡⚡ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| Data-Driven v1 | ~50-100% | ⚡ | ⭐ | ⭐ |
| Data-Driven v2 | 129.34% ❌ | ⚡ | ⭐ | ⭐ |
| PINNs Original | ~10-15% | ⚡ | ⭐⭐ | ⭐⭐ |
| **PINNs v2** | **3.08%** ⭐ | ⚡ | ⭐⭐⭐⭐⭐ | **⭐⭐⭐⭐⭐** |

### 3.2 推奨用途（更新版）

#### Physics-based
- ✅ リアルタイムシミュレーション
- ✅ 高速プロトタイピング
- ✅ 確実な物理再現

#### PINNs v2 ⭐ **推奨**
- ✅ **高精度が要求される場合**
- ✅ **エネルギー保存が重要な場合**
- ✅ 複雑な境界条件への拡張
- ✅ データが限られている場合
- ✅ **物理法則の明示的な組み込み**

#### Data-driven（非推奨）
- ❌ 波動方程式には不向き
- ⚠️ 短期予測（1-2ステップ）のみ可能
- 🔧 アーキテクチャの抜本的変更が必要

---

## 4. 今後の課題

### 4.1 完了 ✅
- [x] PINNs v2 のエネルギー保存改善
- [x] データ駆動型 v2 の改善試行（失敗を記録）

### 4.2 優先度：高
- [ ] PINNs v2 のさらなる最適化
  - [ ] ハイパーパラメータチューニング
  - [ ] 複数の初期条件でのテスト
  - [ ] より長時間のシミュレーション

### 4.3 優先度：中
- [ ] 物理ベースモデルの高速化
  - [ ] GPU実装
  - [ ] 適応的メッシュ

### 4.4 優先度：低（保留）
- [ ] データ駆動型の抜本的改善
  - [ ] ConvLSTM/Transformer への変更
  - [ ] ハイブリッドアプローチ

---

**最終更新**: 2025年12月12日  
**バージョン**: 2.1 (Data-Driven v2 検証追加)
